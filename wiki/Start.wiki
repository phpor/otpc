#labels Phase-Deploy
怎样运行，测试otpc系统

= Introduction =
如果你已经有Linux的环境，请忽略下面有些步骤。在这里将介绍从Windows XP
下开始利用免费软件建立测试环境的方法。
<pre>
利用到的免费软件
 VWPlayer 3.0
 CentOS 5.0 (考虑到兼容问题，这次故意没有用最新版本)
 gcc
 openssl
</pre>

= Details =
下载并安装VWPlayer 3.0
 http://downloads.vmware.com/d/info/desktop_downloads/vmware_player/3_0

下载CentOS的image
 http://www.vmware.com/appliances/directory/820

运行VWPlayer并启动CentOS

运行以下命令安装gcc到CentOS
<pre>
# yum install gcc gcc-c++ autoconf automake
</pre>

下载安装openssl到CentOS
<pre>
# cd openssl-*.*.*
# ./config shared
# make
# make test
# make install
</pre>

下载otpd-3.1.0.tar.gz到CentOS
例: wget http://code.google.com/p/otpc/downloads/detail?name=otpd-3.1.0.tar.gz&can=2&q=

以下命令安装现有的OTPD系统
<pre>
gtar zxvf otpd-3.1.0.tar.gz
cd otpd-3.1.0/
./configure
make
make install

mkdir /etc/otpstate
touch /etc/otppasswd
chmod 600 /etc/otppasswd
chmod 700 /etc/otpstate
mkdir /var/run/otpd
touch /var/run/otpd/socket
</pre>

利用适当的OATH对应的Token客户端
<pre>
http://code.google.com/p/oathtoken/
</pre>
* 运行于其它手机上的，OATH对应的Token都可以。没有找到合适的Windows上可以利用，如果你知道，请给我们联系。

设置OTP服务器
把Token客户端的key共享给OTP服务器
<pre>
cat >> /etc/otppasswd
Test2:hotp-d6:80d4d335194ae378fa901767596969bc213e6535
</pre>
在这里，Test2是用户名，你可以根据需要做修改
hotp-d6表示算法是htop,会生成6位的OTP
后面部分是Token客户端的key(每个客户端都会有一个唯一的秘密的key,由于这个系统和客户端程序没有有效的交换key的办法，为了测试这里只能直接拷贝)

在Token客户端生成两次OTP，用以下命令来同步客户端和OTP服务器
<pre>
resynctool -1 152979 -2 758041 -u Test2 -k 80d4d335194ae378fa901767596969bc213e6535 > /etc/otpstate/foo
</pre>

为了测试动态口令，首先启动OTP服务器
<pre>
# otpd -D
otpd: otpd 3.1.0 starting
otpd: accept_thread: tid=3086179248
</pre>

在Token客户端生成新的动态口令，用以下命令来验证它是否有效
<pre>
# otpauth -u Test2 -p 995880 -s /var/run/otpd/socket
0 (ok)
</pre>
* 由于在VMware上，你只能打开一个窗口，这里需要sshd或者telnet来访问CentOS。写这个测试经过的时候是使用了Tera Term.

如果出现 0 (ok)的话，说明动态口令通过了验证。你也可以验证OTP服务器
是非拒绝错误的，或者已经使用过的动态口令
<pre>
# otpauth -u Test2 -p 995880 -s /var/run/otpd/socket 
otpauth: connect(/var/run/otpd/socket): Connection refused
-1 (invalid return code)
</pre>

每个Token的状态已文件方式保存在服务器上。
<pre>
# ls /etc/otpstate
foo  Test2  Test3  Test4
# cat /etc/otpstate/Test3
5:Test3:0000000000000009:::0:4bea8f01:0:
</pre>
在/etc/otpstate文件夹里，状态文件以Token名作为文件名，在文件里面
0000000000000009 表示现在Token的使用次数。

If you look at the contents of /etc/otpstate/foo you should see something like:
5:foo:0000000000000003:::0:0:0: